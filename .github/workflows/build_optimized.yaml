name: "Build optimized"
run-name: "Building optimized version of smart contracts"

on:
  workflow_call:

jobs:
  generate_release_version:
    runs-on: "ubuntu-latest"
    outputs:
      release_version: "${{ steps.release_version.outputs.release_version }}"
    steps:
      - id: "release_version"
        shell: "sh"
        run: |
          release_version="${{ github.ref_name }}-$(date -Iminute)"

          echo "release_version=${release_version}" >> "$GITHUB_OUTPUT"

          echo "Release version: ${release_version}" >> "${GITHUB_STEP_SUMMARY}"
  build_optimized_platform_contracts:
    runs-on: "ubuntu-latest"
    needs: "generate_release_version"
    steps:
      - uses: "actions/checkout@v4.1.1"
      - name: "Build optimized binaries of platform contracts"
        uses: "./.github/actions/optimized_build"
        with:
          release_version: "${{ needs.generate_release_version.outputs.release_version }}"
          working_directory: "platform"
  build_optimized_protocol_contracts:
    runs-on: "ubuntu-latest"
    needs: "generate_release_version"
    strategy:
      fail-fast: false
      matrix:
        net: ["dev", "test", "main"]
        protocol: ["osmosis", "astroport"]
    steps:
      - uses: "actions/checkout@v4.1.1"
      - name: "Build optimized binaries of protocol contracts"
        uses: "./.github/actions/optimized_build"
        with:
          target_net: ${{ matrix.net }}
          target_protocol: "${{ matrix.protocol }}"
          release_version: "${{ needs.generate_release_version.outputs.release_version }}"
          working_directory: "protocol"
