name: "Code coverage"
run-name: "Running code coverage for smart contracts"

on:
  workflow_call:
  schedule:
    - cron: "0 0 * * *"

env:
  CARGO_TERM_COLOR: "always"
  # Release version is set to `ci` to allow building during checking and testing
  # pipelines, which is ignored during optimized builds.
  RELEASE_VERSION: "ci"
  # Network's name is set to `main` to allow building during checking and testing
  # pipelines, which is ignored during optimized builds.
  NET: "main"

jobs:
  code_coverage:
    uses: "./.github/workflows/code_coverage.yaml"
    strategy:
      fail-fast: false
      matrix:
        working_directory: [ "protocol" ]
        net: [ "dev", "test", "main" ]
        protocol: [ "astroport", "osmosis-osmosis-usdc_axelar", "osmosis-osmosis-usdc_noble" ]
        include:
          - working_directory: "platform"
          - protocol: "osmosis-osmosis-usdc_axelar"
            working_directory: "tests"
          - protocol: "osmosis-osmosis-usdc_noble"
            working_directory: "tests"
          # - protocol: "astroport" # TODO Add `astroport`
          #   working_directory: "tests"
    name: "Code Coverage Protocol [${{ matrix.working_directory }}; ${{ matrix.net }}; ${{ matrix.protocol }}]"
    with:
      target_net: "${{ matrix.net }}"
      target_protocol: "${{ matrix.protocol }}"
      protocols_list: "astroport,osmosis"
      working_directory: "${{ matrix.working_directory }}"
